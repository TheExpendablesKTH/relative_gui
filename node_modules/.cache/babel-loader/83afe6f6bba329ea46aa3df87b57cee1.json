{"ast":null,"code":"\"use strict\"; // Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n// SPDX-License-Identifier: Apache-2.0\n\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\n\nconst DefaultBrowserBehavior_1 = require(\"../browserbehavior/DefaultBrowserBehavior\");\n\nconst SignalingProtocol_js_1 = require(\"../signalingprotocol/SignalingProtocol.js\");\n\nconst Versioning_1 = require(\"../versioning/Versioning\");\n\nconst WebSocketReadyState_1 = require(\"../websocketadapter/WebSocketReadyState\");\n\nconst SignalingClientEvent_1 = require(\"./SignalingClientEvent\");\n\nconst SignalingClientEventType_1 = require(\"./SignalingClientEventType\");\n/**\n * [[DefaultSignalingClient]] implements the SignalingClient interface.\n */\n\n\nclass DefaultSignalingClient {\n  constructor(webSocket, logger) {\n    this.webSocket = webSocket;\n    this.logger = logger;\n    this.unloadHandler = null;\n    this.observerQueue = new Set();\n    this.connectionRequestQueue = [];\n    this.resetConnection();\n    this.logger.debug(() => 'signaling client init');\n    this.audioSessionId = this.generateNewAudioSessionId();\n  }\n\n  registerObserver(observer) {\n    this.logger.debug(() => 'registering signaling client observer');\n    this.observerQueue.add(observer);\n  }\n\n  removeObserver(observer) {\n    this.logger.debug(() => 'removing signaling client observer');\n    this.observerQueue.delete(observer);\n  }\n\n  openConnection(request) {\n    this.logger.info('adding connection request to queue: ' + request.url());\n    this.connectionRequestQueue.push(request);\n    this.closeConnection();\n  }\n\n  pingPong(pingPongFrame) {\n    this.logger.debug(() => 'sending ping');\n    const message = SignalingProtocol_js_1.SdkSignalFrame.create();\n    message.type = SignalingProtocol_js_1.SdkSignalFrame.Type.PING_PONG;\n    message.pingPong = pingPongFrame;\n    this.sendMessage(message);\n    return message.timestampMs;\n  }\n\n  join(settings) {\n    this.logger.info('sending join');\n    const joinFrame = SignalingProtocol_js_1.SdkJoinFrame.create();\n    joinFrame.protocolVersion = 2;\n    joinFrame.maxNumOfVideos = settings.maxVideos;\n    joinFrame.flags = SignalingProtocol_js_1.SdkJoinFlags.HAS_STREAM_UPDATE;\n    const browserBehavior = new DefaultBrowserBehavior_1.default();\n\n    if (browserBehavior.supportsSenderSideBandwidthEstimation()) {\n      joinFrame.flags |= SignalingProtocol_js_1.SdkJoinFlags.USE_SEND_SIDE_BWE;\n    }\n\n    joinFrame.flags |= settings.sendBitrates ? SignalingProtocol_js_1.SdkJoinFlags.SEND_BITRATES : 0;\n    joinFrame.clientDetails = SignalingProtocol_js_1.SdkClientDetails.create({\n      platformName: browserBehavior.name(),\n      platformVersion: browserBehavior.version(),\n      clientSource: Versioning_1.default.sdkName,\n      chimeSdkVersion: Versioning_1.default.sdkVersion\n    });\n    joinFrame.audioSessionId = this.audioSessionId;\n    const message = SignalingProtocol_js_1.SdkSignalFrame.create();\n    message.type = SignalingProtocol_js_1.SdkSignalFrame.Type.JOIN;\n    message.join = joinFrame;\n    this.sendMessage(message);\n  }\n\n  subscribe(settings) {\n    const subscribeFrame = SignalingProtocol_js_1.SdkSubscribeFrame.create();\n    subscribeFrame.sendStreams = [];\n    subscribeFrame.sdpOffer = settings.sdpOffer;\n    subscribeFrame.audioCheckin = settings.audioCheckin;\n    subscribeFrame.audioHost = settings.audioHost;\n    subscribeFrame.audioMuted = settings.audioMuted;\n\n    if (settings.connectionTypeHasVideo) {\n      subscribeFrame.receiveStreamIds = settings.receiveStreamIds;\n    }\n\n    subscribeFrame.duplex = SignalingProtocol_js_1.SdkStreamServiceType.RX;\n\n    if (!settings.audioCheckin) {\n      const audioStream = SignalingProtocol_js_1.SdkStreamDescriptor.create();\n      audioStream.mediaType = SignalingProtocol_js_1.SdkStreamMediaType.AUDIO;\n      audioStream.trackLabel = 'AmazonChimeExpressAudio';\n      audioStream.attendeeId = settings.attendeeId;\n      audioStream.streamId = 1;\n      audioStream.groupId = 1;\n      audioStream.framerate = 15;\n      audioStream.maxBitrateKbps = 600;\n      audioStream.avgBitrateBps = 400000;\n      subscribeFrame.sendStreams.push(audioStream);\n    }\n\n    if (settings.localVideoEnabled) {\n      subscribeFrame.duplex = SignalingProtocol_js_1.SdkStreamServiceType.DUPLEX;\n\n      for (let i = 0; i < settings.videoStreamDescriptions.length; i++) {\n        // Non-simulcast use DefaultVideoStreamIndex.localStreamDescriptions\n        // which is the exact old behavior\n        const streamDescription = settings.videoStreamDescriptions[i].clone();\n        streamDescription.attendeeId = settings.attendeeId;\n        subscribeFrame.sendStreams.push(streamDescription.toStreamDescriptor());\n      }\n    }\n\n    const message = SignalingProtocol_js_1.SdkSignalFrame.create();\n    message.type = SignalingProtocol_js_1.SdkSignalFrame.Type.SUBSCRIBE;\n    message.sub = subscribeFrame;\n    this.sendMessage(message);\n  }\n\n  leave() {\n    const message = SignalingProtocol_js_1.SdkSignalFrame.create();\n    message.type = SignalingProtocol_js_1.SdkSignalFrame.Type.LEAVE;\n    message.leave = SignalingProtocol_js_1.SdkLeaveFrame.create();\n    this.sendMessage(message);\n    this.logger.debug(() => {\n      return 'sent leave';\n    });\n  }\n\n  sendClientMetrics(clientMetricFrame) {\n    const message = SignalingProtocol_js_1.SdkSignalFrame.create();\n    message.type = SignalingProtocol_js_1.SdkSignalFrame.Type.CLIENT_METRIC;\n    message.clientMetric = clientMetricFrame;\n    this.sendMessage(message);\n  }\n\n  sendDataMessage(messageFrame) {\n    const message = SignalingProtocol_js_1.SdkSignalFrame.create();\n    message.type = SignalingProtocol_js_1.SdkSignalFrame.Type.DATA_MESSAGE;\n    message.dataMessage = messageFrame;\n    this.sendMessage(message);\n  }\n\n  closeConnection() {\n    if (this.webSocket.readyState() !== WebSocketReadyState_1.default.None && this.webSocket.readyState() !== WebSocketReadyState_1.default.Closed) {\n      this.isClosing = true;\n      this.sendEvent(new SignalingClientEvent_1.default(this, SignalingClientEventType_1.default.WebSocketClosing, null));\n      this.webSocket.close();\n      this.deactivatePageUnloadHandler();\n    } else {\n      this.logger.info('no existing connection needs closing');\n      this.serviceConnectionRequestQueue();\n    }\n  }\n\n  ready() {\n    return this.webSocket.readyState() === WebSocketReadyState_1.default.Open && !this.isClosing && this.wasOpened;\n  }\n\n  mute(muted) {\n    const message = SignalingProtocol_js_1.SdkSignalFrame.create();\n    message.type = SignalingProtocol_js_1.SdkSignalFrame.Type.AUDIO_CONTROL;\n    const audioControl = SignalingProtocol_js_1.SdkAudioControlFrame.create();\n    audioControl.muted = muted;\n    message.audioControl = audioControl;\n    this.sendMessage(message);\n  }\n\n  pause(streamIds) {\n    const message = SignalingProtocol_js_1.SdkSignalFrame.create();\n    message.type = SignalingProtocol_js_1.SdkSignalFrame.Type.PAUSE;\n    message.pause = SignalingProtocol_js_1.SdkPauseResumeFrame.create();\n    message.pause.streamIds = streamIds;\n    this.sendMessage(message);\n  }\n\n  resume(streamIds) {\n    const message = SignalingProtocol_js_1.SdkSignalFrame.create();\n    message.type = SignalingProtocol_js_1.SdkSignalFrame.Type.RESUME;\n    message.pause = SignalingProtocol_js_1.SdkPauseResumeFrame.create();\n    message.pause.streamIds = streamIds;\n    this.sendMessage(message);\n  }\n\n  resetConnection() {\n    this.webSocket.destroy();\n    this.wasOpened = false;\n  }\n\n  sendMessage(message) {\n    message.timestampMs = Date.now();\n    this.logger.debug(() => `sending: ${JSON.stringify(message)}`);\n    const buffer = this.prependWithFrameTypeRTC(SignalingProtocol_js_1.SdkSignalFrame.encode(message).finish());\n\n    if (this.ready()) {\n      if (!this.webSocket.send(buffer)) {\n        this.sendEvent(new SignalingClientEvent_1.default(this, SignalingClientEventType_1.default.WebSocketSendMessageFailure, null));\n        return;\n      }\n\n      this.sendEvent(new SignalingClientEvent_1.default(this, SignalingClientEventType_1.default.WebSocketSentMessage, null));\n    } else {\n      this.sendEvent(new SignalingClientEvent_1.default(this, SignalingClientEventType_1.default.WebSocketSkippedMessage, null));\n    }\n  }\n\n  receiveMessage(inBuffer) {\n    let message;\n\n    try {\n      message = SignalingProtocol_js_1.SdkSignalFrame.decode(inBuffer);\n    } catch (e) {\n      this.logger.info(`failed to decode: ${inBuffer}`);\n      this.sendEvent(new SignalingClientEvent_1.default(this, SignalingClientEventType_1.default.ProtocolDecodeFailure, null));\n      return;\n    }\n\n    this.logger.debug(() => `received: ${JSON.stringify(message)}`);\n\n    if (this.webSocket.readyState() === WebSocketReadyState_1.default.Open) {\n      this.sendEvent(new SignalingClientEvent_1.default(this, SignalingClientEventType_1.default.ReceivedSignalFrame, message));\n    } else {\n      this.logger.info(`skipping notification of message since WebSocket is not open: ${JSON.stringify(message)}`);\n    }\n  }\n\n  stripFrameTypeRTC(inBuffer) {\n    const frameType = inBuffer[0]; // TODO: change server frame type to send 0x05\n\n    if (frameType !== DefaultSignalingClient.FRAME_TYPE_RTC && frameType !== 0x02) {\n      this.logger.warn(`expected FrameTypeRTC for message but got ${frameType}`);\n    }\n\n    return inBuffer.slice(1);\n  }\n\n  prependWithFrameTypeRTC(inBuffer) {\n    const outBuffer = new Uint8Array(inBuffer.length + 1);\n    outBuffer[0] = DefaultSignalingClient.FRAME_TYPE_RTC;\n    outBuffer.set(inBuffer, 1);\n    return outBuffer;\n  }\n\n  serviceConnectionRequestQueue() {\n    if (this.connectionRequestQueue.length === 0) {\n      this.logger.info('no connection requests to service');\n      return;\n    }\n\n    const request = this.connectionRequestQueue.shift();\n    this.logger.info(`opening connection to ${request.url()}`);\n    this.isClosing = false;\n    this.webSocket.create(request.url(), request.protocols());\n    this.setUpEventListeners();\n    this.sendEvent(new SignalingClientEvent_1.default(this, SignalingClientEventType_1.default.WebSocketConnecting, null));\n  }\n\n  sendEvent(event) {\n    switch (event.type) {\n      case SignalingClientEventType_1.default.WebSocketMessage:\n      case SignalingClientEventType_1.default.ReceivedSignalFrame:\n      case SignalingClientEventType_1.default.WebSocketSentMessage:\n        this.logger.debug(() => `notifying event: ${SignalingClientEventType_1.default[event.type]}`);\n        break;\n\n      case SignalingClientEventType_1.default.WebSocketSkippedMessage:\n        this.logger.debug(() => `notifying event: ${SignalingClientEventType_1.default[event.type]}, websocket state=${WebSocketReadyState_1.default[this.webSocket.readyState()]}`);\n        break;\n\n      default:\n        this.logger.info(`notifying event: ${SignalingClientEventType_1.default[event.type]}`);\n        break;\n    }\n\n    for (const observer of this.observerQueue) {\n      observer.handleSignalingClientEvent(event);\n    }\n  }\n\n  setUpEventListeners() {\n    this.webSocket.addEventListener('open', () => {\n      this.activatePageUnloadHandler();\n      this.wasOpened = true;\n      this.sendEvent(new SignalingClientEvent_1.default(this, SignalingClientEventType_1.default.WebSocketOpen, null));\n    });\n    this.webSocket.addEventListener('message', event => {\n      this.sendEvent(new SignalingClientEvent_1.default(this, SignalingClientEventType_1.default.WebSocketMessage, null));\n      this.receiveMessage(this.stripFrameTypeRTC(new Uint8Array(event.data)));\n    });\n    this.webSocket.addEventListener('close', event => {\n      this.deactivatePageUnloadHandler();\n      this.resetConnection();\n      this.sendEvent(new SignalingClientEvent_1.default(this, SignalingClientEventType_1.default.WebSocketClosed, null, event.code, event.reason));\n      this.serviceConnectionRequestQueue();\n    });\n    this.webSocket.addEventListener('error', () => {\n      if (this.isClosing && !this.wasOpened) {\n        this.logger.info('ignoring error closing signaling while connecting');\n        return;\n      }\n\n      if (this.wasOpened) {\n        this.logger.error('received error while connected');\n        this.sendEvent(new SignalingClientEvent_1.default(this, SignalingClientEventType_1.default.WebSocketError, null));\n      } else {\n        this.logger.error('failed to connect');\n        this.sendEvent(new SignalingClientEvent_1.default(this, SignalingClientEventType_1.default.WebSocketFailed, null));\n      }\n    });\n  }\n\n  activatePageUnloadHandler() {\n    this.unloadHandler = () => {\n      this.leave();\n    }; // eslint-disable-next-line @typescript-eslint/no-explicit-any\n\n\n    const GlobalAny = global;\n    GlobalAny['window'] && GlobalAny['window']['addEventListener'] && window.addEventListener('unload', this.unloadHandler);\n  }\n\n  deactivatePageUnloadHandler() {\n    // eslint-disable-next-line @typescript-eslint/no-explicit-any\n    const GlobalAny = global;\n    GlobalAny['window'] && GlobalAny['window']['addEventListener'] && window.removeEventListener('unload', this.unloadHandler);\n    this.unloadHandler = null;\n  }\n\n  generateNewAudioSessionId() {\n    const num = new Uint32Array(1);\n    const randomNum = window.crypto.getRandomValues(num);\n    return randomNum[0];\n  }\n\n}\n\nexports.default = DefaultSignalingClient;\nDefaultSignalingClient.FRAME_TYPE_RTC = 0x5;","map":{"version":3,"sources":["../../src/signalingclient/DefaultSignalingClient.ts"],"names":[],"mappings":"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","sourceRoot":"","sourcesContent":["\"use strict\";\n// Copyright Amazon.com, Inc. or its affiliates. All Rights Reserved.\n// SPDX-License-Identifier: Apache-2.0\nObject.defineProperty(exports, \"__esModule\", { value: true });\nconst DefaultBrowserBehavior_1 = require(\"../browserbehavior/DefaultBrowserBehavior\");\nconst SignalingProtocol_js_1 = require(\"../signalingprotocol/SignalingProtocol.js\");\nconst Versioning_1 = require(\"../versioning/Versioning\");\nconst WebSocketReadyState_1 = require(\"../websocketadapter/WebSocketReadyState\");\nconst SignalingClientEvent_1 = require(\"./SignalingClientEvent\");\nconst SignalingClientEventType_1 = require(\"./SignalingClientEventType\");\n/**\n * [[DefaultSignalingClient]] implements the SignalingClient interface.\n */\nclass DefaultSignalingClient {\n    constructor(webSocket, logger) {\n        this.webSocket = webSocket;\n        this.logger = logger;\n        this.unloadHandler = null;\n        this.observerQueue = new Set();\n        this.connectionRequestQueue = [];\n        this.resetConnection();\n        this.logger.debug(() => 'signaling client init');\n        this.audioSessionId = this.generateNewAudioSessionId();\n    }\n    registerObserver(observer) {\n        this.logger.debug(() => 'registering signaling client observer');\n        this.observerQueue.add(observer);\n    }\n    removeObserver(observer) {\n        this.logger.debug(() => 'removing signaling client observer');\n        this.observerQueue.delete(observer);\n    }\n    openConnection(request) {\n        this.logger.info('adding connection request to queue: ' + request.url());\n        this.connectionRequestQueue.push(request);\n        this.closeConnection();\n    }\n    pingPong(pingPongFrame) {\n        this.logger.debug(() => 'sending ping');\n        const message = SignalingProtocol_js_1.SdkSignalFrame.create();\n        message.type = SignalingProtocol_js_1.SdkSignalFrame.Type.PING_PONG;\n        message.pingPong = pingPongFrame;\n        this.sendMessage(message);\n        return message.timestampMs;\n    }\n    join(settings) {\n        this.logger.info('sending join');\n        const joinFrame = SignalingProtocol_js_1.SdkJoinFrame.create();\n        joinFrame.protocolVersion = 2;\n        joinFrame.maxNumOfVideos = settings.maxVideos;\n        joinFrame.flags = SignalingProtocol_js_1.SdkJoinFlags.HAS_STREAM_UPDATE;\n        const browserBehavior = new DefaultBrowserBehavior_1.default();\n        if (browserBehavior.supportsSenderSideBandwidthEstimation()) {\n            joinFrame.flags |= SignalingProtocol_js_1.SdkJoinFlags.USE_SEND_SIDE_BWE;\n        }\n        joinFrame.flags |= settings.sendBitrates ? SignalingProtocol_js_1.SdkJoinFlags.SEND_BITRATES : 0;\n        joinFrame.clientDetails = SignalingProtocol_js_1.SdkClientDetails.create({\n            platformName: browserBehavior.name(),\n            platformVersion: browserBehavior.version(),\n            clientSource: Versioning_1.default.sdkName,\n            chimeSdkVersion: Versioning_1.default.sdkVersion,\n        });\n        joinFrame.audioSessionId = this.audioSessionId;\n        const message = SignalingProtocol_js_1.SdkSignalFrame.create();\n        message.type = SignalingProtocol_js_1.SdkSignalFrame.Type.JOIN;\n        message.join = joinFrame;\n        this.sendMessage(message);\n    }\n    subscribe(settings) {\n        const subscribeFrame = SignalingProtocol_js_1.SdkSubscribeFrame.create();\n        subscribeFrame.sendStreams = [];\n        subscribeFrame.sdpOffer = settings.sdpOffer;\n        subscribeFrame.audioCheckin = settings.audioCheckin;\n        subscribeFrame.audioHost = settings.audioHost;\n        subscribeFrame.audioMuted = settings.audioMuted;\n        if (settings.connectionTypeHasVideo) {\n            subscribeFrame.receiveStreamIds = settings.receiveStreamIds;\n        }\n        subscribeFrame.duplex = SignalingProtocol_js_1.SdkStreamServiceType.RX;\n        if (!settings.audioCheckin) {\n            const audioStream = SignalingProtocol_js_1.SdkStreamDescriptor.create();\n            audioStream.mediaType = SignalingProtocol_js_1.SdkStreamMediaType.AUDIO;\n            audioStream.trackLabel = 'AmazonChimeExpressAudio';\n            audioStream.attendeeId = settings.attendeeId;\n            audioStream.streamId = 1;\n            audioStream.groupId = 1;\n            audioStream.framerate = 15;\n            audioStream.maxBitrateKbps = 600;\n            audioStream.avgBitrateBps = 400000;\n            subscribeFrame.sendStreams.push(audioStream);\n        }\n        if (settings.localVideoEnabled) {\n            subscribeFrame.duplex = SignalingProtocol_js_1.SdkStreamServiceType.DUPLEX;\n            for (let i = 0; i < settings.videoStreamDescriptions.length; i++) {\n                // Non-simulcast use DefaultVideoStreamIndex.localStreamDescriptions\n                // which is the exact old behavior\n                const streamDescription = settings.videoStreamDescriptions[i].clone();\n                streamDescription.attendeeId = settings.attendeeId;\n                subscribeFrame.sendStreams.push(streamDescription.toStreamDescriptor());\n            }\n        }\n        const message = SignalingProtocol_js_1.SdkSignalFrame.create();\n        message.type = SignalingProtocol_js_1.SdkSignalFrame.Type.SUBSCRIBE;\n        message.sub = subscribeFrame;\n        this.sendMessage(message);\n    }\n    leave() {\n        const message = SignalingProtocol_js_1.SdkSignalFrame.create();\n        message.type = SignalingProtocol_js_1.SdkSignalFrame.Type.LEAVE;\n        message.leave = SignalingProtocol_js_1.SdkLeaveFrame.create();\n        this.sendMessage(message);\n        this.logger.debug(() => {\n            return 'sent leave';\n        });\n    }\n    sendClientMetrics(clientMetricFrame) {\n        const message = SignalingProtocol_js_1.SdkSignalFrame.create();\n        message.type = SignalingProtocol_js_1.SdkSignalFrame.Type.CLIENT_METRIC;\n        message.clientMetric = clientMetricFrame;\n        this.sendMessage(message);\n    }\n    sendDataMessage(messageFrame) {\n        const message = SignalingProtocol_js_1.SdkSignalFrame.create();\n        message.type = SignalingProtocol_js_1.SdkSignalFrame.Type.DATA_MESSAGE;\n        message.dataMessage = messageFrame;\n        this.sendMessage(message);\n    }\n    closeConnection() {\n        if (this.webSocket.readyState() !== WebSocketReadyState_1.default.None &&\n            this.webSocket.readyState() !== WebSocketReadyState_1.default.Closed) {\n            this.isClosing = true;\n            this.sendEvent(new SignalingClientEvent_1.default(this, SignalingClientEventType_1.default.WebSocketClosing, null));\n            this.webSocket.close();\n            this.deactivatePageUnloadHandler();\n        }\n        else {\n            this.logger.info('no existing connection needs closing');\n            this.serviceConnectionRequestQueue();\n        }\n    }\n    ready() {\n        return (this.webSocket.readyState() === WebSocketReadyState_1.default.Open && !this.isClosing && this.wasOpened);\n    }\n    mute(muted) {\n        const message = SignalingProtocol_js_1.SdkSignalFrame.create();\n        message.type = SignalingProtocol_js_1.SdkSignalFrame.Type.AUDIO_CONTROL;\n        const audioControl = SignalingProtocol_js_1.SdkAudioControlFrame.create();\n        audioControl.muted = muted;\n        message.audioControl = audioControl;\n        this.sendMessage(message);\n    }\n    pause(streamIds) {\n        const message = SignalingProtocol_js_1.SdkSignalFrame.create();\n        message.type = SignalingProtocol_js_1.SdkSignalFrame.Type.PAUSE;\n        message.pause = SignalingProtocol_js_1.SdkPauseResumeFrame.create();\n        message.pause.streamIds = streamIds;\n        this.sendMessage(message);\n    }\n    resume(streamIds) {\n        const message = SignalingProtocol_js_1.SdkSignalFrame.create();\n        message.type = SignalingProtocol_js_1.SdkSignalFrame.Type.RESUME;\n        message.pause = SignalingProtocol_js_1.SdkPauseResumeFrame.create();\n        message.pause.streamIds = streamIds;\n        this.sendMessage(message);\n    }\n    resetConnection() {\n        this.webSocket.destroy();\n        this.wasOpened = false;\n    }\n    sendMessage(message) {\n        message.timestampMs = Date.now();\n        this.logger.debug(() => `sending: ${JSON.stringify(message)}`);\n        const buffer = this.prependWithFrameTypeRTC(SignalingProtocol_js_1.SdkSignalFrame.encode(message).finish());\n        if (this.ready()) {\n            if (!this.webSocket.send(buffer)) {\n                this.sendEvent(new SignalingClientEvent_1.default(this, SignalingClientEventType_1.default.WebSocketSendMessageFailure, null));\n                return;\n            }\n            this.sendEvent(new SignalingClientEvent_1.default(this, SignalingClientEventType_1.default.WebSocketSentMessage, null));\n        }\n        else {\n            this.sendEvent(new SignalingClientEvent_1.default(this, SignalingClientEventType_1.default.WebSocketSkippedMessage, null));\n        }\n    }\n    receiveMessage(inBuffer) {\n        let message;\n        try {\n            message = SignalingProtocol_js_1.SdkSignalFrame.decode(inBuffer);\n        }\n        catch (e) {\n            this.logger.info(`failed to decode: ${inBuffer}`);\n            this.sendEvent(new SignalingClientEvent_1.default(this, SignalingClientEventType_1.default.ProtocolDecodeFailure, null));\n            return;\n        }\n        this.logger.debug(() => `received: ${JSON.stringify(message)}`);\n        if (this.webSocket.readyState() === WebSocketReadyState_1.default.Open) {\n            this.sendEvent(new SignalingClientEvent_1.default(this, SignalingClientEventType_1.default.ReceivedSignalFrame, message));\n        }\n        else {\n            this.logger.info(`skipping notification of message since WebSocket is not open: ${JSON.stringify(message)}`);\n        }\n    }\n    stripFrameTypeRTC(inBuffer) {\n        const frameType = inBuffer[0];\n        // TODO: change server frame type to send 0x05\n        if (frameType !== DefaultSignalingClient.FRAME_TYPE_RTC && frameType !== 0x02) {\n            this.logger.warn(`expected FrameTypeRTC for message but got ${frameType}`);\n        }\n        return inBuffer.slice(1);\n    }\n    prependWithFrameTypeRTC(inBuffer) {\n        const outBuffer = new Uint8Array(inBuffer.length + 1);\n        outBuffer[0] = DefaultSignalingClient.FRAME_TYPE_RTC;\n        outBuffer.set(inBuffer, 1);\n        return outBuffer;\n    }\n    serviceConnectionRequestQueue() {\n        if (this.connectionRequestQueue.length === 0) {\n            this.logger.info('no connection requests to service');\n            return;\n        }\n        const request = this.connectionRequestQueue.shift();\n        this.logger.info(`opening connection to ${request.url()}`);\n        this.isClosing = false;\n        this.webSocket.create(request.url(), request.protocols());\n        this.setUpEventListeners();\n        this.sendEvent(new SignalingClientEvent_1.default(this, SignalingClientEventType_1.default.WebSocketConnecting, null));\n    }\n    sendEvent(event) {\n        switch (event.type) {\n            case SignalingClientEventType_1.default.WebSocketMessage:\n            case SignalingClientEventType_1.default.ReceivedSignalFrame:\n            case SignalingClientEventType_1.default.WebSocketSentMessage:\n                this.logger.debug(() => `notifying event: ${SignalingClientEventType_1.default[event.type]}`);\n                break;\n            case SignalingClientEventType_1.default.WebSocketSkippedMessage:\n                this.logger.debug(() => `notifying event: ${SignalingClientEventType_1.default[event.type]}, websocket state=${WebSocketReadyState_1.default[this.webSocket.readyState()]}`);\n                break;\n            default:\n                this.logger.info(`notifying event: ${SignalingClientEventType_1.default[event.type]}`);\n                break;\n        }\n        for (const observer of this.observerQueue) {\n            observer.handleSignalingClientEvent(event);\n        }\n    }\n    setUpEventListeners() {\n        this.webSocket.addEventListener('open', () => {\n            this.activatePageUnloadHandler();\n            this.wasOpened = true;\n            this.sendEvent(new SignalingClientEvent_1.default(this, SignalingClientEventType_1.default.WebSocketOpen, null));\n        });\n        this.webSocket.addEventListener('message', (event) => {\n            this.sendEvent(new SignalingClientEvent_1.default(this, SignalingClientEventType_1.default.WebSocketMessage, null));\n            this.receiveMessage(this.stripFrameTypeRTC(new Uint8Array(event.data)));\n        });\n        this.webSocket.addEventListener('close', (event) => {\n            this.deactivatePageUnloadHandler();\n            this.resetConnection();\n            this.sendEvent(new SignalingClientEvent_1.default(this, SignalingClientEventType_1.default.WebSocketClosed, null, event.code, event.reason));\n            this.serviceConnectionRequestQueue();\n        });\n        this.webSocket.addEventListener('error', () => {\n            if (this.isClosing && !this.wasOpened) {\n                this.logger.info('ignoring error closing signaling while connecting');\n                return;\n            }\n            if (this.wasOpened) {\n                this.logger.error('received error while connected');\n                this.sendEvent(new SignalingClientEvent_1.default(this, SignalingClientEventType_1.default.WebSocketError, null));\n            }\n            else {\n                this.logger.error('failed to connect');\n                this.sendEvent(new SignalingClientEvent_1.default(this, SignalingClientEventType_1.default.WebSocketFailed, null));\n            }\n        });\n    }\n    activatePageUnloadHandler() {\n        this.unloadHandler = () => {\n            this.leave();\n        };\n        // eslint-disable-next-line @typescript-eslint/no-explicit-any\n        const GlobalAny = global;\n        GlobalAny['window'] &&\n            GlobalAny['window']['addEventListener'] &&\n            window.addEventListener('unload', this.unloadHandler);\n    }\n    deactivatePageUnloadHandler() {\n        // eslint-disable-next-line @typescript-eslint/no-explicit-any\n        const GlobalAny = global;\n        GlobalAny['window'] &&\n            GlobalAny['window']['addEventListener'] &&\n            window.removeEventListener('unload', this.unloadHandler);\n        this.unloadHandler = null;\n    }\n    generateNewAudioSessionId() {\n        const num = new Uint32Array(1);\n        const randomNum = window.crypto.getRandomValues(num);\n        return randomNum[0];\n    }\n}\nexports.default = DefaultSignalingClient;\nDefaultSignalingClient.FRAME_TYPE_RTC = 0x5;\n//# sourceMappingURL=DefaultSignalingClient.js.map"]},"metadata":{},"sourceType":"script"}